<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>SPARQL Query</title>
	<link rel="stylesheet" href="https://static.icos-cp.eu/constant/bootstrap/3.3.4/css/bootstrap.min.css">

	<script type="text/javascript" src="https://static.icos-cp.eu/constant/jquery/1.11.2/jquery.min.js"></script>

	<script type="text/javascript">

		function syntaxHighlight(json) {
			if (typeof json != 'string') {
				json = JSON.stringify(json, undefined, 2);
			}
			json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
			return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
				var cls = 'number';
				if (/^"/.test(match)) {
					if (/:$/.test(match)) {
						cls = 'key';
					} else {
						cls = 'string';
					}
				} else if (/true|false/.test(match)) {
					cls = 'boolean';
				} else if (/null/.test(match)) {
					cls = 'null';
				}
				return '<span class="' + cls + '">' + match + '</span>';
			});
		}

		function init(config){
			$("#result").hide();
			$("#messDiv").hide();

			$("#queryBtn").click(function(){

				var start = new Date().getTime();

				$.ajax({
					type: "POST",
					data: {query: $("#query").val()},
					url: config.sparqlUrl,
					dataType: "json",
					success: function(result){
						var requestTime = new Date().getTime() - start;

						$("#result").show();

						var highlightStart = new Date().getTime();
						$("#result").html(syntaxHighlight(result));
						var highlightTime = new Date().getTime() - highlightStart;

						$("#statusSpan").text(
								result.results.bindings.length + " bindings returned (" +
								requestTime + " ms request, " + highlightTime + " ms styling).");

						$("#queryBtn").prop("class", "btn btn-success")

						setTimeout(function(){
							$("#queryBtn").prop("class", "btn btn-primary")
						}, 3000);
					},
					error: function(req, textStatus, errorThrown) {
						$("#result").show();
						$("#statusSpan").text("");
						$("#queryBtn").prop("class", "btn btn-danger")
						$("#messSpan").text("Could not execute query").show().delay(3000).fadeOut();
						console.log(req);
						$("#result").html(req.responseText);
					}
				});
			});
		}

		function queryConfig(){
			return $.ajax({
				type: "GET",
				url: "local-config.json",
				dataType: "json"
			});
		}

		$(function () {
			var config = {
				sparqlUrl: "https://meta.icos-cp.eu/sparql"
			};

			var configPromise = queryConfig();

			configPromise
				.done(function (result) {
					if (result.localSparqlUrl !== undefined) {
						config.sparqlUrl = result.localSparqlUrl;
						init(config);
					} else {
						init(config);
					}
				})
				.fail(function (request) {
					init(config);
				});
		});

	</script>

	<style type="text/css">
		.container-fluid{margin-top: 5px;}
		button{position: relative;top:-11px;}
		.string { color: green; }
		.number { color: darkorange; }
		.boolean { color: blue; }
		.null { color: magenta; }
		.key { color: red; }
	</style>
</head>

<body>
	<div class="container-fluid">

		<div class="row-fluid">
			<div class="span12">
				<textarea id="query" cols="150" rows="10"></textarea>
				<button id="queryBtn" class="btn btn-primary">Submit query</button>
				<span id="statusSpan"></span>
				<span id="messSpan"></span>
			</div>
		</div>


		<div class="row-fluid">
			<div class="span12">
				<pre id="result"></pre>
			</div>
		</div>

	</div>

</body>
</html>